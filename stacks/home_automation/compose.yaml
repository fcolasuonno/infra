configs:
  mosquitto_config:
    content: |
      user mosquitto
      password_file /mosquitto/passwd/mosquitto.passwd
      port 1883
      listener 9001
      protocol websockets
      persistence true
      persistence_location /mosquitto/data
      allow_anonymous false

networks:
  apps:
    name: compose_apps
    external: true
services:
  mqtt:
    restart: unless-stopped
    container_name: mqtt
    image: eclipse-mosquitto
    labels:
      caddy.layer4.:1883.route.proxy: "{{ upstreams 1883 }}"
    networks:
      apps:
        ipv4_address: ${MACVLAN_MQTT_IP}
    configs:
      - source: mosquitto_config
        target: /mosquitto/config/mosquitto.conf
    volumes:
      - ${DOCKER_DIR}/mqtt/config:/mosquitto/passwd
      - ${DOCKER_DIR}/mqtt/data:/mosquitto/data
      - ${DOCKER_DIR}/mqtt/log:/mosquitto/log
    environment:
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
  mqttui:
    labels:
      backup: true
      caddy: mqttui.muletto.colasuonno.net
      caddy.reverse_proxy: "{{upstreams 5000}}"
    restart: unless-stopped
    container_name: mqttui
    image: terdia07/mqttui:latest
    networks:
      apps:
        ipv4_address: ${MACVLAN_MQTTUI_IP}
    environment:
      - MQTT_BROKER=mqtt
      - MQTT_USERNAME=${MQTT_USERNAME}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
  zigbee2mqtt:
    labels:
      caddy: zigbee2mqtt.muletto.colasuonno.net
      caddy.reverse_proxy: "{{upstreams 8080}}"
    restart: unless-stopped
    container_name: zigbee2mqtt
    image: koenkk/zigbee2mqtt
    networks:
      apps:
        ipv4_address: ${MACVLAN_ZIGBEE2MQTT_IP}
    privileged: true
    volumes:
      - ${DOCKER_DIR}/zigbee2mqtt/config:/app/data
    environment:
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
      - START_DOCKER=false
  homeassistant:
    labels:
      caddy: hass.muletto.colasuonno.net, homeassistant.muletto.colasuonno.net
      caddy.reverse_proxy: "{{upstreams 8123}}"
    restart: unless-stopped
    container_name: homeassistant
    image: homeassistant/home-assistant:stable
    networks:
      apps:
        ipv4_address: ${MACVLAN_HOMEASSISTANT_IP}
    volumes:
      - ${DOCKER_DIR}/homeassistant/config:/config
      - ${MERGERFS_ROOT}/Media/HomeAssistant:/media
    environment:
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
  apcupsd:
    labels:
      backup: true
    image: gregewing/apcupsd:latest
    container_name: apcupsd-stack
    devices:
      - /dev/usb/hiddev0
    networks:
      apps:
        ipv4_address: ${MACVLAN_APCUPSD_IP}
    environment:
      - UPSNAME=smartups750
      - TZ=${TZ} # Default value is Europe/London
    volumes:
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket
      - /etc/apcupsd
    restart: unless-stopped
