---
#
# Tasks and roles for all hosts
#
- hosts: fleet
  gather_facts: no

  pre_tasks:
    - import_tasks: tasks/ssh_juggle_port.yml
      tags:
        - port
    - import_tasks: tasks/dir_copy.yml
      tags:
        - backup
      when: enable_backup | default(False)

- hosts: fleet
  become: yes

  roles:
      #
      # Basics
      #
      - role: system
        tags:
            - system

      - role: geerlingguy.security
        tags:
            - security

      - role: docker
        tags:
            - docker

      - role: chriswayg.msmtp-mailer
        tags:
            - msmtp

      - role: oefenweb.dns
        tags:
            - dns

      - role: geerlingguy.ntp
        tags:
            - ntp

      - role: linux-system-roles.cockpit
        tags:
            - cockpit
        when: enable_cockpit | default(False)

      #
      # Security
      #
      - role: security/iptables
        tags:
            - iptables
        when: enable_iptables | default(False)

      - role: security/crowdsec
        tags:
            - crowdsec
        when: enable_crowdsec | default(False)

      #
      # Network
      #
      - role: network/traefik
        become: no
        tags:
          - traefik
          - containers

    #
    # Filesystems
      #
      - role: filesystems/mergerfs
        become: yes
        tags:
            - mergerfs
        when: enable_nas_stuff | default(False)

      - role: filesystems/mounts
        become: yes
        tags:
            - mounts
        when: enable_nas_stuff | default(False)

      - role: filesystems/hd-idle
        become: yes
        tags:
            - hd-idle
        when: enable_nas_stuff | default(False)

      - role: stuvusit.smartd
        become: yes
        tags:
            - smartd
        when: enable_nas_stuff | default(False)

      - role: ironicbadger.snapraid
        become: yes
        tags:
            - snapraid
        when: enable_nas_stuff | default(False)

      #
      # Services
      #
      - role: containers/services/heimdall
        become: no
        tags:
          - heimdall
          - containers

      - role: containers/services/rdesktop
        become: no
        tags:
          - rdesktop
          - containers
        when: enable_rdesktop | default(False)

      #
      # System
      #
      - role: containers/system/watchtower
        become: no
        tags:
            - watchtower
            - containers

      #
      # Media
      #

      - role: containers/media/plex
        become: no
        tags:
          - plex
          - containers
        when: enable_plex | default(False)

      - role: containers/media/jellyfin
        become: no
        tags:
          - jellyfin
          - containers
        when: enable_jellyfin | default(False)

      - role: containers/media/ubooquity
        become: no
        tags:
          - ubooquity
          - containers
        when: enable_ubooquity | default(False)

      - role: containers/media/calibre-web
        become: no
        tags:
          - calibre-web
          - containers
        when: enable_calibre_web | default(False)

    #
    # System
    #

      - role: containers/system/portainer
        tags:
          - portainer
          - containers
        when: enable_portainer | default(False)

      - role: containers/system/cloudcmd
        tags:
          - cloudcmd
          - containers
        when: enable_cloudcmd | default(False)

      - role: containers/system/busybox
        tags:
          - busybox
          - containers
        when: enable_busybox | default(True)

      - role: containers/system/cloudflared
        tags:
          - cloudflared
          - containers
        when: enable_cloudflared | default(False)

    #
    # Home automation
    #

      - role: containers/homeautomation/homeassistant
        become: no
        tags:
          - homeassistant
          - smarthome
          - containers
        when: enable_homeassistant | default(False)

      - role: containers/homeautomation/mqtt
        become: no
        tags:
          - mqtt
          - smarthome
          - containers
        when: enable_mqtt | default(False)

      - role: containers/homeautomation/zigbee2mqtt
        become: no
        tags:
          - z2mqtt
          - smarthome
          - containers
        when: enable_zigbee2mqtt | default(False)

      - role: containers/homeautomation/valetudomapper
        become: no
        tags:
          - valetudomapper
          - containers
        when: enable_valetudomapper | default(False)

    #
    # Samba
    #
      - role: bertvv.samba
        become: yes
        tags:
          - samba
        when: enable_nas_stuff | default(False)
